<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ø¯ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)</title>
    <style>
        :root {
            --primary-color: #2c3e50; --secondary-color: #3498db; --light-gray: #ecf0f1;
            --dark-gray: #bdc3c7; --green: #2ecc71; --red: #e74c3c; --orange: #f39c12;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); margin: 0; color: var(--primary-color); }
        header { background-color: var(--primary-color); color: white; padding: 1rem; text-align: center; position: relative; }
        nav { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .nav-btn { background: var(--secondary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 14px;}
        .nav-btn:hover, .nav-btn.active { background-color: #2980b9; }
        main { padding: 20px; max-width: 900px; margin: 0 auto; }
        .page { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .page.active { display: block; }
        .input-group, .filter-group { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        input[type="text"], select { padding: 8px; border: 1px solid var(--dark-gray); border-radius: 4px; flex-grow: 1; }
        button, .action-btn { background-color: var(--secondary-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 14px; }
        button:hover, .action-btn:hover { opacity: 0.9; }
        .ring { border: 1px solid var(--dark-gray); border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fff; }
        .ring-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--light-gray); padding-bottom: 10px; }
        .student-list { padding: 0; margin: 0; list-style: none; }
        .student-list li { padding: 12px 8px; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .student-name { flex-grow: 1; }
        .student-actions { display: flex; gap: 8px; }
        .action-btn.move { background-color: var(--orange); }
        .action-btn.delete { background-color: var(--red); }
        .student-name-group .last-memo { color: #7f8c8d; font-size: 0.8em; }
        .memorization-input-group { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .memorization-input-group input[type="text"] { min-width: 150px; }
        .status-indicator { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .status-indicator.present { background-color: var(--green); }
        .status-indicator.absent { background-color: var(--red); }
        #csvExportBtn { position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; background: none; border: none; padding: 5px; color: white;}
        textarea { width: calc(100% - 20px); margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid var(--dark-gray); font-family: inherit; font-size: 1em; direction: rtl; text-align: right; }
        .ring-footer { margin-top: 15px; text-align: left; }
        .message-section { margin-top: 25px; }
        .message-section h3 { border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px;}
        .message-group { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;}
        .copy-btn { background-color: var(--green); font-size: 18px; padding: 5px 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid var(--dark-gray); text-align: right; }
        thead { background-color: var(--primary-color); color: white; }


/* Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ù‚Ø³Ù… Ø§Ù„Ù€ style */
#manualCopyModal {
    display: none; 
    position: fixed; 
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}
.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 85%;
    max-width: 500px;
    border-radius: 8px;
    position: relative;
    text-align: center;
}
.close-btn {
    color: #aaa;
    position: absolute;
    left: 15px;
    top: 5px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.close-btn:hover {
    color: black;
}
#manualCopyTextarea {
    width: 100%;
    height: 200px;
    margin-top: 10px;
    margin-bottom: 15px;
    padding: 10px;
    box-sizing: border-box;
    font-size: 1em;
    direction: rtl;
    text-align: right;
}


    </style>
</head>
<body>

    <header>
        <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h1>
        <button id="csvExportBtn" onclick="app.exportToCSV()" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„Ù CSV">ğŸ’¾</button>
        <nav>
            <button class="nav-btn active" data-page="ringsPage">ğŸ“š Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø­Ù„Ù‚Ø§Øª</button>
            <button class="nav-btn" data-page="attendancePage">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
            <button class="nav-btn" data-page="memorizationPage">ğŸ“– ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª</button>
            <button class="nav-btn" data-page="statsPage">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</button>
            <button class="nav-btn" data-page="parentsMessagePage">âœ‰ï¸ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‡Ø§Ù„ÙŠ</button>
        </nav>
    </header>

    <main>
        <div id="ringsPage" class="page active">
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø­Ù„Ù‚Ø§Øª</h2>
            <div class="input-group">
                <input type="text" id="newRingName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <button onclick="app.addRing()">Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø©</button>
            </div>
            <div class="input-group">
                <label for="csvFileInput">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù CSV:</label>
                <input type="file" id="csvFileInput" accept=".csv" onchange="app.importFromCSV(event)">
            </div>
            <div id="ringsContainer"></div>
        </div>

        <div id="attendancePage" class="page">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ØªØ§Ø±ÙŠØ®: <span id="currentDateAttendance"></span></h2>
            <div id="attendanceContainer"></div>
        </div>

        <div id="memorizationPage" class="page">
             <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª Ù„ØªØ§Ø±ÙŠØ®: <span id="currentDateMemorization"></span></h2>
             <div id="memorizationContainer"></div>
        </div>
        
        <div id="statsPage" class="page">
    <h2>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª (Ù…ØµÙÙˆÙØ©)</h2>
    <div class="filter-group">
        <label for="ringMatrixFilter">Ø§Ø®ØªØ± Ø§Ù„Ø­Ù„Ù‚Ø©:</label>
        <select id="ringMatrixFilter" onchange="app.renderStats()">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</option>
        </select>

        <label for="dataTypeFilter">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª:</label>
        <select id="dataTypeFilter" onchange="app.renderStats()">
            <option value="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</option>
            <option value="memorization">Ø§Ù„Ø­ÙØ¸ (ØµÙØ­Ø§Øª)</option>
            <option value="points">Ø§Ù„Ù†Ù‚Ø§Ø·</option>
        </select>

        <button class="action-btn delete" onclick="app.resetAllPoints()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·</button>
    </div>

    <div style="overflow-x:auto;">
      <table id="statsTable">
          <thead></thead>
          <tbody></tbody>
      </table>
    </div>
</div>

        <div id="parentsMessagePage" class="page">
    <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‡Ø§Ù„ÙŠ</h2>
    
    <div class="message-section">
        <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (Ù„ÙƒÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª)</h3>

        <div class="input-group" style="padding: 10px; background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
            <label for="dismissalTimeInput" style="font-weight: bold;">ğŸ•˜ Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø·Ù„Ø§Ø¨:</label>
            <input type="time" id="dismissalTimeInput" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px;">
        </div>
        
        <div class="message-group">
            <span>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¬Ù…Ø¹</span>
            <button class="copy-btn" onclick="app.generateAllAttendanceReport()">ğŸ“‹</button>
        </div>
    </div>

    <div class="message-section">
        <h3>ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØµÙ„Ø© (Ø­Ø³Ø¨ Ø§Ù„Ø­Ù„Ù‚Ø©)</h3>
        <div id="ringMessageContainer"></div>
    </div>
</div>
    </main>
<div id="manualCopyModal" style="display:none;">
    <div class="modal-content">
        <span class="close-btn" onclick="app.closeModal()">&times;</span>
        <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø³Ø®</h3>
        <textarea id="manualCopyTextarea" readonly></textarea>
       
    </div>
</div>
    <script>
    const app = {
data: { rings: [], records: [], lastStudentId: 0 },
        // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
        init() {
    this.loadData();
    this.updateStudentIdsIfNeeded(); // <-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø§
    this.setupEventListeners();
    this.navigateTo('ringsPage');
},

        setupEventListeners() {
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', () => this.navigateTo(button.dataset.page));
            });
        },

        navigateTo(pageId) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
            document.querySelectorAll('.page').forEach(page => page.style.display = page.id === pageId ? 'block' : 'none');

            const pageRenderers = {
                ringsPage: this.renderRings,
                attendancePage: this.renderAttendance,
                memorizationPage: this.renderMemorization,
                statsPage: this.renderStats,
                parentsMessagePage: this.renderParentMessagesPage
            };
            pageRenderers[pageId]?.call(this);
        },
        
        loadData() {
            const savedData = localStorage.getItem('mosqueAppData');
            if (savedData) this.data = JSON.parse(savedData);
        },

        saveData() {
            localStorage.setItem('mosqueAppData', JSON.stringify(this.data));
        },

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ (Ù…Ø¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
        addRing() {
            const ringName = document.getElementById('newRingName').value.trim();
            if (!ringName || this.data.rings.some(r => r.name === ringName)) {
                alert('Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ÙØ§Ø±Øº Ø£Ùˆ Ù…ÙƒØ±Ø±.');
                return;
            }
            this.data.rings.push({ name: ringName, students: [] });
            document.getElementById('newRingName').value = '';
            this.saveData();
            this.renderRings();
        },

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
formatPageNumbers(pagesArray) {
    if (!pagesArray || pagesArray.length === 0) {
        // Ù†Ø±Ø¬Ø¹ Ù‚ÙŠÙ…Ø© ÙØ§Ø±ØºØ© Ù„Ù†ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        return null; 
    }
    if (pagesArray.length === 1) {
        return `Ø§Ù„ØµÙØ­Ø© ${pagesArray[0]}`;
    }
    const firstPage = pagesArray[0];
    const lastPage = pagesArray[pagesArray.length - 1];
    return `Ø§Ù„ØµÙØ­Ø§Øª Ù…Ù† ${firstPage} Ø¥Ù„Ù‰ ${lastPage}`;
},
         resetAllPoints() {
        if (!confirm("ØªØ­Ø°ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø§Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
            return;
        }
        this.data.records.forEach(record => {
            record.points = 0;
        });
        this.saveData();
        alert("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø§Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ± Ø¨Ù†Ø¬Ø§Ø­.");
    },

       addStudent(ringName) {
    const studentName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨:');
    if (!studentName || studentName.trim() === '') return;
    
    const ring = this.data.rings.find(r => r.name === ringName);
    if (ring.students.some(s => s.name === studentName.trim())) {
        alert('Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ù„Ù‚Ø©.');
        return;
    }

    // **Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ**
    // 1. Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ù…Ù‚Ø¯Ø§Ø± 1
    this.data.lastStudentId = (this.data.lastStudentId || 0) + 1;
    // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const studentId = this.data.lastStudentId;
    
    ring.students.push({ id: studentId, name: studentName.trim() });
    this.saveData();
    this.renderRings();
},
        
        deleteStudent(studentId, ringName) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø³Ø¬Ù„Ø§ØªÙ‡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø£ÙŠØ¶Ù‹Ø§.")) {
                return;
            }
            const ring = this.data.rings.find(r => r.name === ringName);
            if (ring) {
                ring.students = ring.students.filter(s => s.id !== studentId);
            }
            this.data.records = this.data.records.filter(r => r.studentId !== studentId);
            this.saveData();
            this.renderRings();
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
        },

        moveStudent(studentId, currentRingName) {
            const otherRings = this.data.rings.filter(r => r.name !== currentRingName);
            if (otherRings.length === 0) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„ÙŠÙ‡Ø§.");
                return;
            }
            const ringNames = otherRings.map(r => r.name).join('\n');
            const newRingName = prompt(`Ø§Ø®ØªØ± Ø­Ù„Ù‚Ø© Ù„Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„ÙŠÙ‡Ø§:\n${ringNames}`);

            if (!newRingName || !otherRings.some(r => r.name === newRingName)) {
                alert("Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡.");
                return;
            }

            const currentRing = this.data.rings.find(r => r.name === currentRingName);
            const newRing = this.data.rings.find(r => r.name === newRingName);
            const studentToMove = currentRing.students.find(s => s.id === studentId);

            if (currentRing && newRing && studentToMove) {
                currentRing.students = currentRing.students.filter(s => s.id !== studentId);
                newRing.students.push(studentToMove);
                this.saveData();
                this.renderRings();
                alert(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ "${studentToMove.name}" Ø¥Ù„Ù‰ Ø­Ù„Ù‚Ø© "${newRingName}" Ø¨Ù†Ø¬Ø§Ø­.`);
            }
        },
        
        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« IDs Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ÙŠ (ØªØ¹Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
updateStudentIdsIfNeeded() {
    // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ„ Ø·Ø§Ù„Ø¨ Ù„Ø¯ÙŠÙ‡ ID Ù…Ù† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø±Ù‚Ù… Ø¹Ø´Ø±ÙŠ)
    const firstStudent = this.data.rings[0]?.students[0];
    if (!firstStudent || Number.isInteger(firstStudent.id)) {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø§Ø¨ØŒ Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„ÙØ¹Ù„ ØªØ±ØªÙŠØ¨ÙŠØ©ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§
        return; 
    }

    console.log("ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰...");
    let newIdCounter = 0;
    const idMap = new Map(); // Ø®Ø±ÙŠØ·Ø© Ù„Ø±Ø¨Ø· Ø§Ù„Ù€ ID Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯

    // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¹Ø·Ø§Ø¡ Ø£Ø±Ù‚Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
    this.data.rings.forEach(ring => {
        ring.students.forEach(student => {
            newIdCounter++;
            idMap.set(student.id, newIdCounter); // Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯
            student.id = newIdCounter;
        });
    });

    // Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„ØªØ¹ÙƒØ³ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    this.data.records.forEach(record => {
        if (idMap.has(record.studentId)) {
            record.studentId = idMap.get(record.studentId);
        }
    });

    // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¢Ø®Ø± Ø±Ù‚Ù… ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
    this.data.lastStudentId = newIdCounter;
    
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…
    this.saveData();
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯!");
},

      renderRings() {
    const container = document.getElementById('ringsContainer');
    container.innerHTML = this.data.rings.map(ring => {
        const sortedStudents = [...ring.students].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        return `
            <div class="ring">
                <div class="ring-header">
                    <h3>${ring.name}</h3>
                    <div class="student-actions">
                        <button onclick="app.addStudent('${ring.name}')">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                        <button class="action-btn" onclick="app.editRingName('${ring.name}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
                        <button class="action-btn delete" onclick="app.deleteRing('${ring.name}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø©</button>
                    </div>
                </div>
                <ul class="student-list">
                    ${sortedStudents.map(s => `
                        <li>
                            <span class="student-name">${s.name}</span>
                            <div class="student-actions">
                                <button class="action-btn" onclick="app.editStudentName(${s.id}, '${ring.name}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="action-btn move" onclick="app.moveStudent(${s.id}, '${ring.name}')">ğŸ”„ Ù†Ù‚Ù„</button>
                                <button class="action-btn delete" onclick="app.deleteStudent(${s.id}, '${ring.name}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            </div>
                        </li>
                    `).join('') || '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯</li>'}
                </ul>
            </div>
        `;
    }).join('');
},
// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§
saveDraft(studentId, field, value) {
    const draftKey = `draft-${studentId}`;
    let draft = JSON.parse(localStorage.getItem(draftKey) || '{}');
    draft[field] = value;
    localStorage.setItem(draftKey, JSON.stringify(draft));
},
        // --- Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) ---
        toggleAttendance(studentId) {
            const today = new Date().toISOString().split('T')[0];
            let record = this.data.records.find(r => r.studentId === studentId && r.date === today);
            if (!record) {
                record = { studentId, date: today, attendance: 'present', pages: [], points: 0 };
                this.data.records.push(record);
            } else {
                record.attendance = record.attendance === 'present' ? 'absent' : 'present';
            }
            this.saveData();
            this.renderAttendance();
        },
        
       renderAttendance() {
    const container = document.getElementById('attendanceContainer');
    document.getElementById('currentDateAttendance').textContent = new Date().toISOString().split('T')[0];
    container.innerHTML = this.data.rings.map(ring => {
        
        // **Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§**
        const sortedStudents = [...ring.students].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

        return `
            <div class="ring">
                <h3>${ring.name}</h3>
                <ul class="student-list">
                    ${sortedStudents.map(student => { // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø© Ù‡Ù†Ø§
                        const record = this.data.records.find(r => r.studentId === student.id && r.date === new Date().toISOString().split('T')[0]);
                        const status = record?.attendance === 'present' ? 'present' : 'absent';
                        return `<li><span>${student.name}</span><div class="status-indicator ${status}" onclick="app.toggleAttendance(${student.id})"></div></li>`;
                    }).join('') || '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</li>'}
                </ul>
            </div>
        `;
    }).join('');
},
        
        parsePageInput(input) {
            if (!input) return [];
            const pages = new Set();
            input.split(',').forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    if (!isNaN(start) && !isNaN(end) && end >= start) {
                        for (let i = start; i <= end; i++) pages.add(i);
                    }
                } else if (!isNaN(Number(part)) && part !== '') {
                    pages.add(Number(part));
                }
            });
            return Array.from(pages);
        },

deleteRing(ringNameToDelete) {
    const ring = this.data.rings.find(r => r.name === ringNameToDelete);
    if (!ring) return;

    // **Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹**
    if (ring.students.length > 0) {
        alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ù„Ù‚Ø© "${ringNameToDelete}" Ù„Ø£Ù†Ù‡Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¨.\n\nÙŠØ±Ø¬Ù‰ Ù†Ù‚Ù„ Ø£Ùˆ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù†Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹.`);
        return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ù„Ù‚Ø© ÙØ§Ø±ØºØ©ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø­Ø°Ù
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„ÙØ§Ø±ØºØ© "${ringNameToDelete}"ØŸ`)) {
        this.data.rings = this.data.rings.filter(r => r.name !== ringNameToDelete);
        this.saveData();
        this.renderRings();
        alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø© "${ringNameToDelete}" Ø¨Ù†Ø¬Ø§Ø­.`);
    }
},

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
editStudentName(studentId, ringName) {
    const ring = this.data.rings.find(r => r.name === ringName);
    if (!ring) return;

    const student = ring.students.find(s => s.id === studentId);
    if (!student) return;

    const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø·Ø§Ù„Ø¨:", student.name);

    if (!newName || newName.trim() === '' || newName.trim() === student.name) {
        return; // Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø©
    }
    if (ring.students.some(s => s.name === newName.trim())) {
        alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø©.");
        return;
    }
    student.name = newName.trim();
    this.saveData();
    this.renderRings();
},

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©
editRingName(oldRingName) {
    const newRingName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯:", oldRingName);

    if (!newRingName || newRingName.trim() === '' || newRingName.trim() === oldRingName) {
        return; // Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø©
    }
    if (this.data.rings.some(r => r.name === newRingName.trim())) {
        alert("Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
        return;
    }
    const ringToEdit = this.data.rings.find(r => r.name === oldRingName);
    if (ringToEdit) {
        ringToEdit.name = newRingName.trim();
        this.saveData();
        this.renderRings();
    }
},


    saveMemorizationForRing(ringName) {
    const today = new Date().toISOString().split('T')[0];
    const ring = this.data.rings.find(r => r.name === ringName);
    let changesMade = false;
    
    ring.students.forEach(student => {
        const draftKey = `draft-${student.id}`;
        const draft = JSON.parse(localStorage.getItem(draftKey) || '{}');
        
        if (draft.pagesInput) {
            changesMade = true;
            const pagesArray = this.parsePageInput(draft.pagesInput);
            if (pagesArray.length === 0) return;

            const quality = draft.quality || 'normal';
            
            // Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let pointsPer_page = 2;
            if (quality === 'review') pointsPer_page = 1;
            if (quality === 'excellent') pointsPer_page = 3;
            const newPoints = pagesArray.length * pointsPer_page;
            
            let record = this.data.records.find(r => r.studentId === student.id && r.date === today);
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ù„Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
            if (!record) {
                record = { 
                    studentId: student.id, 
                    date: today, 
                    attendance: 'present', 
                    memorizations: [], // **Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯**
                    points: 0 
                };
                this.data.records.push(record);
            }

            // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
            if (!record.memorizations) {
                record.memorizations = [];
            }
            
            // Ø¥Ø¶Ø§ÙØ© "Ø­Ø¯Ø«" Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
            record.memorizations.push({
                pages: pagesArray.sort((a,b)=>a-b),
                quality: quality
            });

            // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø­Ø¶ÙˆØ±
            record.points = (record.points || 0) + newPoints;
            record.attendance = 'present';
            
            localStorage.removeItem(draftKey);
        }
    });
    
    if (changesMade) {
        this.saveData();
        alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ù„Ù‚Ø© "${ringName}"`);
        this.renderMemorization();
    } else {
        const hasAnyDraft = ring.students.some(s => localStorage.getItem(`draft-${s.id}`));
        if (!hasAnyDraft) {
            alert('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸.');
        }
    }
},
        
       renderMemorization() {
    const container = document.getElementById('memorizationContainer');
    document.getElementById('currentDateMemorization').textContent = new Date().toISOString().split('T')[0];
    container.innerHTML = this.data.rings.map(ring => {
        
        // **Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§**
        const sortedStudents = [...ring.students].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

        let ringStudentsHTML = sortedStudents.map(student => {
            const draft = JSON.parse(localStorage.getItem(`draft-${student.id}`) || '{}');
            const quality = draft.quality || 'normal';
            
            return `<li>
                <div class="student-name-group" style="width: 100%;">
                    <strong>${student.name}</strong>
                    <div class="last-memo">Ø¢Ø®Ø± Ø­ÙØ¸: ${
                        (this.data.records.find(r => r.studentId === student.id && r.date === new Date().toISOString().split('T')[0])?.pages.join(', ')) || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'
                    }</div>
                </div>
                <div class="memorization-input-group" style="width: 100%; margin-top: 10px;">
                    <input type="text" id="pages-input-${student.id}" placeholder="ØµÙØ­Ø§Øª Ø§Ù„Ø­ÙØ¸: 121-125" style="flex-grow: 1;" 
                        value="${draft.pagesInput || ''}" oninput="app.saveDraft(${student.id}, 'pagesInput', this.value)">
                </div>
                <div class="student-actions" style="width:100%; margin-top: 10px; justify-content: flex-start;">
                    <label><input type="radio" name="quality-${student.id}" value="review" ${quality === 'review' ? 'checked' : ''} onchange="app.saveDraft(${student.id}, 'quality', this.value)"> Ù…Ø±Ø§Ø¬Ø¹Ø© (1)</label>
                    <label style="margin-right: 15px;"><input type="radio" name="quality-${student.id}" value="normal" ${quality === 'normal' ? 'checked' : ''} onchange="app.saveDraft(${student.id}, 'quality', this.value)"> Ø¹Ø§Ø¯ÙŠ (2)</label>
                    <label style="margin-right: 15px;"><input type="radio" name="quality-${student.id}" value="excellent" ${quality === 'excellent' ? 'checked' : ''} onchange="app.saveDraft(${student.id}, 'quality', this.value)"> Ù…Ù…ØªØ§Ø² (3)</label>
                </div>
            </li>`;
        }).join('');

        return `
            <div class="ring">
                <div class="ring-header"><h3>${ring.name}</h3></div>
                <ul class="student-list">${ringStudentsHTML || '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</li>'}</ul>
                <div class="ring-footer"><button onclick="app.saveMemorizationForRing('${ring.name}')">Ø­ÙØ¸ Ù…Ø­ÙÙˆØ¸Ø§Øª Ø­Ù„Ù‚Ø© ${ring.name}</button></div>
            </div>`;
    }).join('');
},
        // --- Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©) ---
        renderStats() {
            const ringFilter = document.getElementById('ringMatrixFilter').value;
            const dataType = document.getElementById('dataTypeFilter').value;
            const table = document.getElementById('statsTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            let filteredStudents = [];
            if (ringFilter === 'all') {
                filteredStudents = this.data.rings.flatMap(r => r.students);
            } else {
                const selectedRing = this.data.rings.find(r => r.name === ringFilter);
                if (selectedRing) filteredStudents = selectedRing.students;
            }

            filteredStudents.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100%">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ø¹Ø±Ø¶Ù‡Ù….</td></tr>';
                return;
            }

            const studentIds = filteredStudents.map(s => s.id);
            const relevantRecords = this.data.records.filter(r => studentIds.includes(r.studentId));
            const allDates = [...new Set(relevantRecords.map(r => r.date))].sort();

            let headerRow = '<tr><th>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</th>';
            allDates.forEach(date => headerRow += `<th>${date}</th>`);
            headerRow += '</tr>';
            thead.innerHTML = headerRow;

            filteredStudents.forEach(student => {
                let studentRow = `<tr><td>${student.name}</td>`;
                allDates.forEach(date => {
                    const record = relevantRecords.find(r => r.studentId === student.id && r.date === date);
                    let cellContent = '-';
                    if (record) {
                        switch (dataType) {
                            case 'attendance': cellContent = record.attendance === 'present' ? 'âœ…' : 'âŒ'; break;
                            case 'memorization': cellContent = record.pages && record.pages.length > 0 ? record.pages.join(';') : '0'; break;
                            case 'points': cellContent = record.points || 0; break;
                        }
                    } else {
                         if (dataType === 'attendance') cellContent = 'âŒ'; else cellContent = '0';
                    }
                    studentRow += `<td>${cellContent}</td>`;
                });
                studentRow += '</tr>';
                tbody.innerHTML += studentRow;
            });

            const ringFilterSelect = document.getElementById('ringMatrixFilter');
            const currentSelection = ringFilterSelect.value;
            ringFilterSelect.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</option>';
            this.data.rings.forEach(ring => {
                ringFilterSelect.innerHTML += `<option value="${ring.name}">${ring.name}</option>`;
            });
            ringFilterSelect.value = currentSelection;
        },

        // --- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‡Ø§Ù„ÙŠ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©) ---
       showReportForManualCopy(text) {
    const modal = document.getElementById('manualCopyModal');
    const textarea = document.getElementById('manualCopyTextarea');
    textarea.value = text;
    modal.style.display = 'block';
    
    // --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø§ÙØ¸Ø© ---
    if (navigator.clipboard) { // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        navigator.clipboard.writeText(text)
            .then(() => {
                // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ØŒ Ø£Ø¸Ù‡Ø± Ø¥Ø´Ø¹Ø§Ø±Ù‹Ø§ Ø¨Ø³ÙŠØ·Ù‹Ø§
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            })
            .catch(err => {
                console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ', err);
                // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„ØŒ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©
            });
    }
    // -----------------------------------------
    
    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ¨Ù‚ÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¸Ø§Ù‡Ø±Ø© Ù„Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    textarea.focus();
    textarea.select();
},

closeModal() {
    document.getElementById('manualCopyModal').style.display = 'none';
},


// â¬‡ï¸â¬‡ï¸ Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø®Ù„ ÙƒØ§Ø¦Ù† app â¬‡ï¸â¬‡ï¸
shareViaWhatsApp(text) {
    console.log("Preparing to share...");

    // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            console.log('Text copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }

    // 2. ØªØ´ÙÙŠØ± Ø§Ù„Ù†Øµ Ù„Ù„Ø±Ø§Ø¨Ø·
    const encodedText = encodeURIComponent(text);
    
    // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨
    const whatsappUrl = `whatsapp://send?text=${encodedText}`;
    
    // 4. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
    window.open(whatsappUrl, '_blank');
},

copyFromTextarea() {
    const textarea = document.getElementById('manualCopyTextarea');
    textarea.select();
    // Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
    textarea.setSelectionRange(0, 99999); 
    
    // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ù‡Ù†Ø§
    if (navigator.clipboard) {
        navigator.clipboard.writeText(textarea.value)
            .then(() => alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!"))
            .catch(err => alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®."));
    } else {
        // ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        try {
            document.execCommand('copy');
            alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©).");
        } catch (err) {
            alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®.");
        }
    }
},

        getLastActiveDay() {
            if (!this.data.records || this.data.records.length === 0) return null;
            return this.data.records.map(r => r.date).sort().pop();
        },
        
        renderParentMessagesPage() {
            const ringMessageContainer = document.getElementById('ringMessageContainer');
            ringMessageContainer.innerHTML = this.data.rings.map(ring => `
                <div class="message-group">
                    <span>${ring.name}</span>
                    <button class="copy-btn" onclick="app.generateRingReport('${ring.name}')" title="Ù†Ø³Ø® ØªÙ‚Ø±ÙŠØ± Ø­Ù„Ù‚Ø© ${ring.name}">ğŸ“‹</button>
                </div>
            `).join('');
        },

  generateRingReport(ringName) {
    const lastActiveDay = this.getLastActiveDay();
    if (!lastActiveDay) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±.");
        return;
    }

    // --- Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
    // Ø¬Ù„Ø¨ ÙˆØªÙ†Ø³ÙŠÙ‚ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const dismissalTime = document.getElementById('dismissalTimeInput').value;
    let dismissalText = "Ù„Ù… ÙŠØ­Ø¯Ø¯";
    if (dismissalTime) {
        let [hours, minutes] = dismissalTime.split(':');
        const ampm = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
        hours = hours % 12 || 12; // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø© 0 Ø¥Ù„Ù‰ 12
        dismissalText = `${hours}:${minutes} ${ampm}`;
    }
    // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---

    const ring = this.data.rings.find(r => r.name === ringName);
    
    // -- ØªØ¹Ø¯ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„ÙŠØ´Ù…Ù„ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù --
    let reportContent = `â”€â”€ Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ’Ù…Ùâ”€â”€\n\n` +
                      `*ØªÙ‚Ø±ÙŠØ± Ø­Ù„Ù‚Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° ${ring.name}*\n` +
                      `*Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…Ø³Ø¬Ù„: ${lastActiveDay}*\n` +
                      `*ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù: ${dismissalText}*\n\n`;

    const sortedStudents = [...ring.students].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

    sortedStudents.forEach((student, index) => {
        const record = this.data.records.find(r => r.studentId === student.id && r.date === lastActiveDay);
        
        reportContent += `*${index + 1}. ${student.name}:* `;

        if (record?.attendance === 'present') {
            const hasMemorized = (record.memorizations && record.memorizations.length > 0) || (record.pages && record.pages.length > 0);

            if (hasMemorized) {
                reportContent += "Ø­Ø¶Ø± ÙˆØ³Ù…Ø¹ ";
                
                let memoParts = [];
                if (record.memorizations && record.memorizations.length > 0) {
                    record.memorizations.forEach(memoEvent => {
                        let memoText = this.formatPageNumbers(memoEvent.pages);
                        if (memoText) {
                            if (memoEvent.quality === 'excellent') {
                                memoText += " (Ø¨Ø¥ØªÙ‚Ø§Ù† Ù…Ù…ØªØ§Ø² â­)";
                            } else if (memoEvent.quality === 'review') {
                                memoText += " (Ù…Ø±Ø§Ø¬Ø¹Ø©)";
                            }
                            memoParts.push(memoText);
                        }
                    });
                } else if (record.pages) {
                    memoParts.push(this.formatPageNumbers(record.pages));
                }
                
                reportContent += memoParts.join("ØŒ ÙˆØ³Ù…Ø¹ ");
            } else {
                reportContent += "Ø­Ø¶Ø± ÙˆÙ„Ù… ÙŠØ³Ù…Ø¹ Ø´ÙŠØ¦Ù‹Ø§";
            }
        } else {
            reportContent += "Ù„Ù… ÙŠØ­Ø¶Ø±";
        }
        reportContent += '\n\n';
    });

    reportContent += `\nğŸ”¥â¤ï¸ Ø´Ø¯Ù‘ÙˆØ§ Ø§Ù„Ù‡Ù…Ù… â¤ï¸ğŸ”¥`;
this.shareViaWhatsApp(reportContent);

},

      generateAllAttendanceReport() {
    const lastActiveDay = this.getLastActiveDay();
    if (!lastActiveDay) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±.");
        return;
    }

    // -- Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --
    // 1. Ø¬Ù„Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const dismissalTime = document.getElementById('dismissalTimeInput').value;
    let dismissalText = "Ù„Ù… ÙŠØ­Ø¯Ø¯";
    if (dismissalTime) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† 24 Ø³Ø§Ø¹Ø© Ø¥Ù„Ù‰ 12 Ø³Ø§Ø¹Ø© Ù…Ø¹ ØµØ¨Ø§Ø­Ù‹Ø§/Ù…Ø³Ø§Ø¡Ù‹
        let [hours, minutes] = dismissalTime.split(':');
        const ampm = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
        hours = hours % 12 || 12; // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø© 0 Ø¥Ù„Ù‰ 12
        dismissalText = `${hours}:${minutes} ${ampm}`;
    }

    // 2. Ø­Ø³Ø§Ø¨ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    const dateObj = new Date(lastActiveDay);
    // ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
    const dayName = days[dateObj.getDay()];
    // -- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª --

    const allStudents = this.data.rings.flatMap(r => r.students);
    const present = [];
    const absent = [];
    allStudents.forEach(student => {
        const record = this.data.records.find(r => r.studentId === student.id && r.date === lastActiveDay);
        (record?.attendance === 'present' ? present : absent).push(student.name);
    });

    present.sort((a, b) => a.localeCompare(b, 'ar'));
    absent.sort((a, b) => a.localeCompare(b, 'ar'));

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¥Ù„Ù‰ Ù†Øµ Ù…ÙØµÙˆÙ„ Ø¨Ù€ " - " ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ø«Ø§Ù„
    const presentList = present.length > 0 ? present.join(' - ') : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ±";
    const absentList = absent.length > 0 ? absent.join(' - ') : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨";

    // -- Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ --
    let reportContent = `â”â”â”â”â” â—¦ *Ø¨ÙØ³Û¡Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Û¡Ù…Ù°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…* â—¦ â”â”â”â”â”\n` +
                        `${dayName}\n` +
                        `Ø§Ù„ØªØ§Ø±ÙŠØ® (${lastActiveDay.replace(/-/g, '/')})\n` +
                        `â”â”â”â”â”â”â”â”â”â” â—¦ â– â—¦ â”â”â”â”â”â”â”â”â”â”\n` +
                        `â˜š *ØªÙ… Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø·Ù„Ø§Ø¨*\n` +
                        `Ø§Ù„Ø³Ø§Ø¹Ø© ${dismissalText}\n` +
                        `â”â”â”â”â”â”â”â”â”â” â—¦ â– â—¦ â”â”â”â”â”â”â”â”â”â”\n` +
                        `âœ… *Ø§Ù„Ø­Ø¶ÙˆØ±* (${present.length}):\n` +
                        `${presentList}\n` +
                        `â”â”â”â”â”â”â”â”â”â” â—¦ â– â—¦ â”â”â”â”â”â”â”â”â”â”\n` +
                        `âŒ *Ø§Ù„ØºÙŠØ§Ø¨* (${absent.length}):\n` +
                        `${absentList}\n` +
                        `â”â”â”â”â”â”â”â”â”â” â—¦ â– â—¦ â”â”â”â”â”â”â”â”â”â”\n` +
                        `Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¹ÙÙ„ÙÙ‘Ù…Ù’Ù†ÙØ§Ù’ Ù…ÙØ§Ù’ ÙŠÙÙ†Ù’ÙÙØ¹ÙÙ†ÙØ§Ù’ ÙˆÙÙ†Ù’ÙÙØ¹Ù’Ù†ÙØ§Ù’ Ø¨ÙÙ…ÙØ§Ù’ Ø¹ÙÙ„ÙÙ‘Ù…Ù’ØªÙÙ†ÙØ§Ù’ ÙˆÙØ²ÙØ¯Ù’Ù†ÙØ§Ù’ Ø¹ÙÙ„Ù’Ù…ÙØ§Ù‹ ÙˆÙØ¹ÙÙ…ÙÙ„ÙØ§Ù‹ Ù…ÙØªÙÙ‚ÙØ¨ÙÙ‘Ù„Ø§Ù‹ ÙŠÙØ§Ù’ Ø£Ø±Ù’Ø­ÙÙ…Ù Ø§Ù„Ø±ÙÙ‘Ø§Ù’Ø­ÙÙ…ÙÙŠÙ†Ù’..........\n\n` +
                        `Ù„Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ùˆ Ø§Ø³ØªÙØ³Ø§Ø± ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…:\n` +
                        `ğŸ“± 0995657713\n` +
                        `ğŸ“± 0998686631`;

    this.shareViaWhatsApp(reportContent);


},

        // --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©) ---
     importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        const rows = text.split('\n').slice(1);
        let newStudentsCount = 0;
        let recordsAdded = 0;
        let recordsSkipped = 0;

        rows.forEach(row => {
            if (!row.trim()) return;
            // Ø§Ù„Ø¢Ù† Ù†ØªÙˆÙ‚Ø¹ 7 Ø£Ø¹Ù…Ø¯Ø©
            const columns = row.split(',');
            if (columns.length < 7) return;

            const date = columns[0]?.trim();
            const studentName = columns[1]?.trim();
            const ringName = columns[2]?.trim();
            const attendanceText = columns[3]?.trim();
            const pagesText = columns[4]?.trim().replace(/^"|"$/g, '');
            const points = parseInt(columns[5]?.trim() || 0);
            const studentId = parseFloat(columns[6]?.trim()); // **Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ**

            if (!studentName || !date || !studentId) return;
            
            const attendance = attendanceText.includes('Ø­Ø§Ø¶Ø±') ? 'present' : 'absent';
            const pages = pagesText === '-' ? [] : pagesText.split(';').map(p => parseInt(p.trim())).filter(p => !isNaN(p));

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ù€ ID Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª
            let student = this.data.rings.flatMap(r => r.students).find(s => s.id === studentId);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            let ring = this.data.rings.find(r => r.name === ringName);
            if (!ring) {
                ring = { name: ringName, students: [] };
                this.data.rings.push(ring);
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ù€ IDØŒ Ù†Ù†Ø´Ø¦Ù‡ Ø¨Ø§Ù„Ù€ ID Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯
            if (!student) {
                student = { id: studentId, name: studentName };
                ring.students.push(student);
                newStudentsCount++;
            }
            
            // Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø©
            const recordExists = this.data.records.some(r => r.studentId === student.id && r.date === date);
            if (!recordExists) {
                const newRecord = { studentId: student.id, date, attendance, pages, points };
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                if (columns.length > 7 && columns[7]?.trim()) {
                    newRecord.quality = columns[7].trim();
                }
                this.data.records.push(newRecord);
                recordsAdded++;
            } else {
                recordsSkipped++;
            }
        });
        this.saveData();
        alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\nØ·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯: ${newStudentsCount}\nØ³Ø¬Ù„Ø§Øª Ø£Ø¶ÙŠÙØª: ${recordsAdded}\nØ³Ø¬Ù„Ø§Øª ØªÙ… ØªØ®Ø·ÙŠÙ‡Ø§ (Ù…ÙƒØ±Ø±Ø©): ${recordsSkipped}`);
        this.navigateTo('ringsPage');
    };
    reader.readAsText(file, 'UTF-8');
},

      exportToCSV() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    if (!this.data.records || this.data.records.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
        return;
    }

    const csvRows = [];
    const headers = "Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„Ø­Ù„Ù‚Ø©,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª (ØµÙØ­Ø§Øª),Ø§Ù„Ù†Ù‚Ø§Ø·,StudentID\n";
    
    // --- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯Ù‹Ø§ ---
    // Ø§Ù„Ø­Ù„: Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const allDays = [...new Set(this.data.records.map(r => r.date))];

    this.data.rings.forEach(ring => {
        ring.students.forEach(student => {
            allDays.forEach(day => {
                const record = this.data.records.find(r => r.studentId === student.id && r.date === day);
                let attendance, pagesText, points;

                if (record) {
                    attendance = record.attendance === 'present' ? 'âœ… Ø­Ø§Ø¶Ø±' : 'âŒ ØºØ§Ø¦Ø¨';
                    
                    // Ù…Ù†Ø·Ù‚ Ù…Ø­Ø³Ù† Ù„Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø§Øª Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    let pagesArray = [];
                    if (record.memorizations && record.memorizations.length > 0) {
                        pagesArray = record.memorizations.flatMap(m => m.pages);
                    } else if (record.pages) {
                        pagesArray = record.pages; // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                    }
                    pagesText = pagesArray.length > 0 ? pagesArray.join(';') : '-';
                    
                    points = record.points || 0;
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ØºØ§Ø¦Ø¨Ù‹Ø§
                    attendance = 'âŒ ØºØ§Ø¦Ø¨';
                    pagesText = '-';
                    points = 0;
                }
                
                // Ø¥Ø¶Ø§ÙØ© student.id ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø±
                csvRows.push([day, student.name, ring.name, attendance, `"${pagesText}"`, points, student.id].join(','));
            });
        });
    });
    
    // Ø§Ù„ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…) Ø«Ù… Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§
    csvRows.sort((a, b) => {
        const rowA = a.split(',');
        const rowB = b.split(',');
        const dateA = new Date(rowA[0]);
        const dateB = new Date(rowB[0]);
        const nameA = rowA[1];
        const nameB = rowB[1];
        
        if (dateB - dateA !== 0) {
            return dateB - dateA;
        }
        return nameA.localeCompare(nameB, 'ar');
    });

    const fullCsv = headers + csvRows.join('\n');
    const blob = new Blob(["\uFEFF" + fullCsv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø­Ù„Ù‚Ø§Øª_Ø§Ù„ÙƒØ§Ù…Ù„.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
},



    };
    
    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    app.init();

    
    </script>


<script>
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Service Workers
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(error => {
              console.log('ServiceWorker registration failed: ', error);
            });
        });
      }
    </script> 

    
</body>
</html>
